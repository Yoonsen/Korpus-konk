<!DOCTYPE html>
<html>
<head>
  <title>ImagiNation Concordances</title>
  <meta charset="UTF-8" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#a22">
  <link rel="icon" href="icon-192.png" type="image/png">
  <!-- Add Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container my-4">
  <h1 class="text-center mb-4">ImagiNation Concordances</h1>
  <div class="input-group mb-3" style="max-width: 400px; margin: 0 auto;">
    <input type="text" id="query" class="form-control" placeholder="e.g. Norge">
    <button id="searchBtn" class="btn btn-primary">Search</button>
  </div>
  <div id="results" class="border p-3" style="overflow-y: auto; height: calc(100vh - 200px);">
    <div id="status" style="font-size: 12px; margin-bottom: 10px; color: #555;"></div>
  </div>
  
  <script>
    // This will store our extracted ID values
    let dhlabidsArray = [];
    const statusDiv = document.getElementById("status");
    const searchBtn = document.getElementById("searchBtn");
    const queryInput = document.getElementById("query");
    
    // Add a timestamp to prevent caching
    const timestamp = new Date().getTime();
    const jsonUrl = `corpus.json?v=${timestamp}`;
    
    statusDiv.textContent = "Loading corpus data...";
    
    // Load the corpus data when the page loads
    fetch(jsonUrl)
      .then(res => res.json())
      .then(data => {
        console.log("Loaded data structure:", data);
        
        if (data && data.dhlabids) {
          if (Array.isArray(data.dhlabids)) {
            // It's already a proper array
            dhlabidsArray = data.dhlabids;
            statusDiv.textContent = `Loaded corpus with ${dhlabidsArray.length} documents (array format)`;
          } else if (typeof data.dhlabids === 'object') {
            // It's an object with numeric keys, convert to array
            dhlabidsArray = Object.values(data.dhlabids);
            statusDiv.textContent = `Loaded corpus with ${dhlabidsArray.length} documents (object format)`;
          } else {
            statusDiv.textContent = "Error: dhlabids has unexpected format";
            console.error("Unexpected dhlabids format:", typeof data.dhlabids);
          }
        } else {
          statusDiv.textContent = "Error: No dhlabids found in JSON";
          console.error("No dhlabids in data:", data);
        }
      })
      .catch(err => {
        statusDiv.textContent = `Error loading corpus: ${err.message}`;
        console.error("Failed to load corpus data:", err);
      });
    
    // Search function
    async function performSearch() {
      try {
        const query = queryInput.value;
        
        if (!query) {
          alert("Please enter a search term");
          return;
        }
        
        if (!dhlabidsArray || dhlabidsArray.length === 0) {
          alert("Corpus data not loaded yet. Please try again.");
          return;
        }
        
        const resultsDiv = document.getElementById("results");
        statusDiv.textContent = "Searching...";
        resultsDiv.innerHTML = '<div id="status" style="font-size: 12px; margin-bottom: 10px; color: #555;"></div>';
        
        console.log(`Using dhlabidsArray for search (${dhlabidsArray.length} items)`);
        console.log("First few IDs:", dhlabidsArray.slice(0, 5));
        
        // Make a copy of the array before slicing to ensure we're working with an array
        const idsToUse = [...dhlabidsArray].slice(0, 20000);
        
        const concBody = {
          dhlabids: idsToUse,
          query: query,
          limit: 1000,
          window: 20,
          html_formatting: true
        };
        
        console.log("Request body:", concBody);
        
        const concResp = await fetch("https://api.nb.no/dhlab/conc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(concBody)
        });
        
        if (!concResp.ok) {
          throw new Error(`HTTP error ${concResp.status}`);
        }
        
        const conc = await concResp.json();
        
        statusDiv.textContent = `Found results for "${query}"`;
        resultsDiv.innerHTML += "<h2>Concordances</h2>";
        
        if (!conc.conc || Object.keys(conc.conc).length === 0) {
          resultsDiv.innerHTML += "<p>No results found for this query.</p>";
          return;
        }
        
        let matchCount = 0;
        Object.keys(conc.conc).forEach(key => {
          let text = conc.conc[key];
          const urn = conc.urn[key]; // Extract the URN
          const searchText = (text.match(/<b>(.*?)<\/b>/) || [])[1] || ""; // Extract the bolded term
          const urnLink = `https://www.nb.no/items/${urn}?searchText=${encodeURIComponent(searchText)}`; // Build the clickable URL with searchText

          // Replace the <b> element with a clickable link
          if (searchText) {
            text = text.replace(
              `<b>${searchText}</b>`,
              `<a href="${urnLink}" target="_blank" class="text-decoration-underline"><b>${searchText}</b></a>`
            );
          }

          const div = document.createElement("div");
          div.className = "concordance";
          div.innerHTML = `<p>${text}</p>`;
          resultsDiv.appendChild(div);
          matchCount++;
        });
        
        statusDiv.textContent = `Found ${matchCount} matches for "${query}"`;
      } catch (error) {
        statusDiv.textContent = `Error: ${error.message}`;
        document.getElementById("results").innerHTML = `<p class="error">Search failed: ${error.message}</p>`;
        console.error("Search failed:", error);
      }
    }
    
    // Add event listener for search button
    searchBtn.addEventListener("click", performSearch);
    
    // Add event listener for Enter key in the search input
    queryInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault(); // Prevent default form submission
        performSearch();
      }
    });
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
  <!-- Add Bootstrap JS (optional, for interactive components) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
