<!DOCTYPE html>
<html>
<head>
  <title>Corpus Concordance</title>
  <meta charset="UTF-8" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#a22">
</head>
<body>
  <h1>Corpus Concordance Viewer</h1>
  <label>Search term:
    <input type="text" id="query" placeholder="e.g. Norge">
  </label>
  <button id="searchBtn" disabled>Search</button>
  <div id="loading">Loading corpus data...</div>
  <div id="results"></div>
  <script>
    let dhlabids = [];
    const searchBtn = document.getElementById("searchBtn");
    const loadingDiv = document.getElementById("loading");
    
    // Load the corpus data when the page loads
    fetch('corpus.json')
      .then(res => res.json())
      .then(data => {
        dhlabids = data.dhlabids;
        // Enable the search button once data is loaded
        searchBtn.disabled = false;
        loadingDiv.style.display = "none";
      })
      .catch(err => {
        loadingDiv.textContent = "Error loading corpus data: " + err.message;
        console.error("Failed to load corpus data:", err);
      });
    
    // Add event listener instead of inline onclick
    searchBtn.addEventListener("click", run);
    
    async function run() {
      const query = document.getElementById("query").value;
      
      if (!dhlabids || dhlabids.length === 0) {
        alert("Corpus data not loaded yet. Please try again.");
        return;
      }
      
      // Show loading state
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "<p>Searching...</p>";
      
      try {
        const concBody = {
          dhlabids: dhlabids.slice(0, 20000),
          query: query,
          limit: 1000,
          window: 20,
          html_formatting: true
        };
        
        const concResp = await fetch("https://api.nb.no/dhlab/conc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(concBody)
        });
        
        if (!concResp.ok) {
          throw new Error(`HTTP error ${concResp.status}`);
        }
        
        const conc = await concResp.json();
        
        resultsDiv.innerHTML = "<h2>Concordances</h2>";
        
        if (!conc.conc || Object.keys(conc.conc).length === 0) {
          resultsDiv.innerHTML += "<p>No results found for this query.</p>";
          return;
        }
        
        Object.values(conc.conc).forEach(text => {
          const div = document.createElement("div");
          div.className = "concordance";
          div.innerHTML = text;
          resultsDiv.appendChild(div);
        });
      } catch (error) {
        resultsDiv.innerHTML = "<p>Error: " + error.message + "</p>";
        console.error("Search failed:", error);
      }
    }
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>