<!DOCTYPE html>
<html>
<head>
  <title>Corpus Concordance</title>
  <meta charset="UTF-8" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#a22">
  <link rel="icon" href="data:,">
</head>
<body>
  <h1>Corpus Concordance Viewer</h1>
  <label>Search term:
    <input type="text" id="query" placeholder="e.g. Norge">
  </label>
  <button id="searchBtn">Search</button>
  <div id="status"></div>
  <div id="results"></div>
  
  <script>
    // This will store our extracted ID values
    let dhlabidsArray = [];
    const statusDiv = document.getElementById("status");
    const searchBtn = document.getElementById("searchBtn");
    
    // Add a timestamp to prevent caching
    const timestamp = new Date().getTime();
    const jsonUrl = `corpus.json?v=${timestamp}`;
    
    statusDiv.textContent = "Loading corpus data...";
    
    // Load the corpus data when the page loads
    fetch(jsonUrl)
      .then(res => res.json())
      .then(data => {
        console.log("Loaded data structure:", data);
        
        if (data && data.dhlabids) {
          if (Array.isArray(data.dhlabids)) {
            // It's already a proper array
            dhlabidsArray = data.dhlabids;
            statusDiv.textContent = `Loaded corpus with ${dhlabidsArray.length} documents (array format)`;
          } else if (typeof data.dhlabids === 'object') {
            // It's an object with numeric keys, convert to array
            dhlabidsArray = Object.values(data.dhlabids);
            statusDiv.textContent = `Loaded corpus with ${dhlabidsArray.length} documents (object format)`;
          } else {
            statusDiv.textContent = "Error: dhlabids has unexpected format";
            console.error("Unexpected dhlabids format:", typeof data.dhlabids);
          }
        } else {
          statusDiv.textContent = "Error: No dhlabids found in JSON";
          console.error("No dhlabids in data:", data);
        }
      })
      .catch(err => {
        statusDiv.textContent = `Error loading corpus: ${err.message}`;
        console.error("Failed to load corpus data:", err);
      });
    
    // Add event listener for search button
    searchBtn.addEventListener("click", async function() {
      try {
        const query = document.getElementById("query").value;
        
        if (!query) {
          alert("Please enter a search term");
          return;
        }
        
        if (!dhlabidsArray || dhlabidsArray.length === 0) {
          alert("Corpus data not loaded yet. Please try again.");
          return;
        }
        
        const resultsDiv = document.getElementById("results");
        statusDiv.textContent = "Searching...";
        resultsDiv.innerHTML = "";
        
        console.log(`Using dhlabidsArray for search (${dhlabidsArray.length} items)`);
        console.log("First few IDs:", dhlabidsArray.slice(0, 5));
        
        // Make a copy of the array before slicing to ensure we're working with an array
        const idsToUse = [...dhlabidsArray].slice(0, 20000);
        
        const concBody = {
          dhlabids: idsToUse,
          query: query,
          limit: 1000,
          window: 20,
          html_formatting: true
        };
        
        console.log("Request body:", concBody);
        
        const concResp = await fetch("https://api.nb.no/dhlab/conc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(concBody)
        });
        
        if (!concResp.ok) {
          throw new Error(`HTTP error ${concResp.status}`);
        }
        
        const conc = await concResp.json();
        
        statusDiv.textContent = `Found results for "${query}"`;
        resultsDiv.innerHTML = "<h2>Concordances</h2>";
        
        if (!conc.conc || Object.keys(conc.conc).length === 0) {
          resultsDiv.innerHTML += "<p>No results found for this query.</p>";
          return;
        }
        
        let matchCount = 0;
        Object.values(conc.conc).forEach(text => {
          const div = document.createElement("div");
          div.className = "concordance";
          div.innerHTML = text;
          resultsDiv.appendChild(div);
          matchCount++;
        });
        
        statusDiv.textContent = `Found ${matchCount} matches for "${query}"`;
      } catch (error) {
        statusDiv.textContent = `Error: ${error.message}`;
        document.getElementById("results").innerHTML = `<p class="error">Search failed: ${error.message}</p>`;
        console.error("Search failed:", error);
      }
    });
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
